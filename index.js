const express = require('express');
const TelegramBot = require('node-telegram-bot-api');

const app = express();
app.use(express.json());

const PORT = process.env.PORT || 10000;
const TOKEN = '8370855958:AAHC8ry_PsUqso_jC2sAS9CnQnfURk1UW3w';

const bot = new TelegramBot(TOKEN, { polling: true });

let selectedRegion = 'RU';

// Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾ Ð¿Ð°ÐºÐµÑ‚Ð°Ñ… Ð°Ð»Ð¼Ð°Ð·Ð¾Ð² Ð² Ð²Ð¸Ð´Ðµ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð²
const diamondsData = [
    { amount: 56, price: 124 },
    { amount: 86, price: 152 },
    { amount: 172, price: 280 },
    { amount: 257, price: 411 },
    { amount: 706, price: 1224 },
    { amount: 2195, price: 3105 },
    { amount: 3688, price: 5069 },
    { amount: 5532, price: 7446 },
    { amount: 9288, price: 12980 }
];

app.get('/', (req, res) => {
    res.send('Ð¡ÐµÑ€Ð²ÐµÑ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!');
});

app.post('/webhook', (req, res) => {
    try {
        bot.processUpdate(req.body);
    } catch (e) {
        console.error('processUpdate error:', e);
    }
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ 200, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Telegram Ð½Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÐ» Ð·Ð°Ð¿Ñ€Ð¾Ñ.
    res.sendStatus(200);
});

bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;
    bot.sendMessage(chatId, 'Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ! ðŸ‘‹ Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ€ÐµÐ³Ð¸Ð¾Ð½:', {
        reply_markup: {
            inline_keyboard: [
                [
                    { text: 'ðŸ‡·ðŸ‡º RU', callback_data: 'region_ru' },
                    { text: 'ðŸ‡°ðŸ‡¬ KG', callback_data: 'region_kg' }
                ]
            ],
        },
    });
});

bot.on('callback_query', async (q) => {
    const chatId = q.message.chat.id;
    try {
        if (q.data === 'region_ru') {
            selectedRegion = 'RU';
            await showMainMenu(chatId);
        } else if (q.data === 'region_kg') {
            selectedRegion = 'KG';
            await showMainMenu(chatId);
        } else if (q.data === 'buy_diamonds') {
            await showDiamonds(chatId);
        } else if (q.data === 'reviews') {
            await bot.sendMessage(chatId, 'ÐžÑ‚Ð·Ñ‹Ð²Ñ‹ Ð½Ð°ÑˆÐ¸Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²: https://t.me/Ð¢Ð’ÐžÐ™_ÐšÐÐÐÐ›');
        } else if (q.data === 'leave_review') {
            await bot.sendMessage(chatId, 'ÐžÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð·Ñ‹Ð²: @Ð¢Ð’ÐžÐ™_ÐÐ˜Ðš');
        } else if (q.data === 'back_to_start') {
            await showMainMenu(chatId);
        }
        await bot.answerCallbackQuery(q.id);
    } catch (e) {
        console.error('callback error:', e);
    }
});

async function showMainMenu(chatId) {
    await bot.sendMessage(chatId, 'Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ:', {
        reply_markup: {
            inline_keyboard: [
                [
                    { text: 'ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ Ð°Ð»Ð¼Ð°Ð·Ñ‹ ðŸ’Ž', callback_data: 'buy_diamonds' },
                    { text: 'ÐžÑ‚Ð·Ñ‹Ð²Ñ‹ ðŸ’–', callback_data: 'reviews' }
                ],
                [{ text: 'ÐžÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð·Ñ‹Ð² ðŸ’Œ', callback_data: 'leave_review' }]
            ]
        }
    });
}

async function showDiamonds(chatId) {
    const currency = selectedRegion === 'RU' ? 'â‚½' : 'KGS';
    const keyboard = [];
    let currentRow = [];

    // Ð”Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
    diamondsData.forEach((d, index) => {
        currentRow.push({
            text: `${d.amount} Diamonds â€” ${d.price.toLocaleString('ru-RU')} ${currency}`,
            callback_data: `diamond_${d.amount}`
        });

        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ð² ÐºÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ñƒ, ÐºÐ¾Ð³Ð´Ð° Ð² Ð½ÐµÐ¹ 2 ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°
        if (currentRow.length === 2 || index === diamondsData.length - 1) {
            keyboard.push(currentRow);
            currentRow = [];
        }
    });

    keyboard.push([{ text: 'ÐÐ°Ð·Ð°Ð´ ðŸ”™', callback_data: 'back_to_start' }]);

    await bot.sendMessage(chatId, 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð°ÐºÐµÑ‚ Ð°Ð»Ð¼Ð°Ð·Ð¾Ð²:', {
        reply_markup: { inline_keyboard: keyboard },
    });
}

app.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
});
